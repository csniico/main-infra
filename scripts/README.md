# Terraform Backend Management Scripts

This directory contains scripts for managing the AWS infrastructure required for Terraform remote state management. These scripts help you set up and tear down the necessary AWS resources (S3 bucket and DynamoDB table) that Terraform uses to store state files and handle state locking.

## Scripts Overview

### 1. `setup_terraform_backend.sh`

This script provisions the AWS infrastructure required for Terraform remote state management:

- Creates an S3 bucket to store Terraform state files
- Creates a DynamoDB table to handle state locking
- Configures appropriate permissions and security settings
- Generates a Terraform backend configuration file

### 2. `teardown_terraform_backend.sh`

This script removes the AWS infrastructure created by the setup script:

- Deletes the S3 bucket (including all objects inside it)
- Deletes the DynamoDB table
- Provides safety confirmations before deletion

## Prerequisites

- AWS CLI installed and configured
- Bash shell environment
- Appropriate AWS permissions to create/delete S3 buckets and DynamoDB tables

## Usage

### Setup Script

```bash
./setup_terraform_backend.sh [options]
```

Options:

- `-p, --prefix PREFIX`: Resource name prefix (default: "tf-state")
- `-r, --region REGION`: AWS region (default: "us-east-1")
- `-f, --profile PROFILE`: AWS CLI profile to use for authentication (optional)
- `-o, --output-dir DIR`: Directory where backend.tf will be created (default: current directory)
- `-h, --help`: Display help message

Examples:

```bash
# Using default profile and prefix in us-west-2 region
./setup_terraform_backend.sh --region us-west-2

# Using custom prefix and region
./setup_terraform_backend.sh --prefix myproject --region eu-west-1

# Using a named AWS profile
./setup_terraform_backend.sh --prefix myproject --region us-west-2 --profile dev-account

# Specifying an output directory for backend.tf
./setup_terraform_backend.sh --prefix myproject --region us-west-2 --output-dir ./terraform/environments/primary
```

### Teardown Script

```bash
./teardown_terraform_backend.sh [options]
```

Options:

- `-p, --prefix PREFIX`: Resource name prefix (default: "tf-state")
- `-r, --region REGION`: AWS region (default: "us-east-1")
- `-f, --profile PROFILE`: AWS CLI profile to use for authentication (optional)
- `-o, --output-dir DIR`: Directory where backend.tf was created (default: current directory)
- `-h, --help`: Display help message

Examples:

```bash
# Using default profile and prefix in us-west-2 region
./teardown_terraform_backend.sh --region us-west-2

# Using custom prefix and region
./teardown_terraform_backend.sh --prefix myproject --region eu-west-1

# Using a named AWS profile
./teardown_terraform_backend.sh --prefix myproject --region us-west-2 --profile dev-account

# Specifying the output directory where backend.tf was created
./teardown_terraform_backend.sh --prefix myproject --region us-west-2 --output-dir ./terraform/environments/primary
```

## Resource Naming Convention

The scripts use the following naming convention for AWS resources:

- S3 bucket: `{prefix}-{aws-account-id}`
- DynamoDB table: `{prefix}-lock`

Where:

- `{prefix}` is the value provided with the `--prefix` option (default: "tf-state")
- `{aws-account-id}` is your AWS account ID (automatically detected)

## Generated Files

The setup script generates a `backend.tf` file in the specified output directory (or the current directory if not specified) that contains the Terraform backend configuration. You can run `terraform init` in that directory to initialize the backend, or copy the file to another Terraform configuration directory.

Example `backend.tf`:

```hcl
# Generated by setup_terraform_backend.sh
terraform {
  backend "s3" {
    bucket         = "tf-state-123456789012"
    key            = "terraform.tfstate"
    region         = "us-west-2"
    dynamodb_table = "tf-state-lock"
    encrypt        = true
  }
}
```

## Security Considerations

The setup script configures the S3 bucket with the following security settings:

- Server-side encryption enabled
- Public access blocked
- TLS connections enforced
- Versioning enabled to maintain state history

The DynamoDB table is configured with:

- Point-in-time recovery enabled
- Pay-per-request billing mode to optimize costs

## Important Considerations and Risks

1. **Data Loss Risk**: The teardown script will delete all objects in the S3 bucket, including all Terraform state files. This can make it impossible to manage existing infrastructure with Terraform unless you have backups of the state files.

2. **Confirmation Required**: The teardown script requires explicit confirmation before deleting resources to prevent accidental data loss.

3. **Permissions**: Ensure you have the necessary AWS permissions to create and delete S3 buckets and DynamoDB tables.

4. **Cost**: While the resources created by these scripts typically incur minimal AWS charges, you are responsible for any costs associated with the created resources.

5. **State Lock**: If a Terraform operation is interrupted without releasing the state lock, you might need to manually delete the lock from the DynamoDB table.

6. **Shared Usage**: If multiple users or systems use the same backend, coordinate carefully when running the teardown script to avoid disrupting others.

## Best Practices

1. **Backup State Files**: Before running the teardown script, consider downloading a backup of your Terraform state files from the S3 bucket.

2. **Environment Separation**: Use different prefixes for different environments (e.g., dev, staging, prod) to maintain separation of state files.

3. **Access Control**: Implement appropriate IAM policies to control who can access the S3 bucket and DynamoDB table.

4. **Version Control**: Store the generated `backend.tf` file in version control along with your Terraform configuration.

5. **Documentation**: Document the backend configuration in your project documentation to help new team members understand the setup.
